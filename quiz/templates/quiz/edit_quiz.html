{% extends "quiz/layout.html" %}
{% load template_filters %}
{% block body %}
    <form method="POST">
        <div class="container">
            {% csrf_token %}
            {{ quiz_form.as_p }}
            <button type="submit" name="submit_quiz">Create Quiz</button>
        </div>
        <div class="container" id="question_container">
                {% csrf_token %}
                {{ question_formset.management_form }}
                {% for question_form in question_formset %}
                    <div class="sub_container">
                        {{ question_form.as_p }}

                        <!-- Access the answer formset for this question -->
                        {% with answer_formset_key=question_form.instance.id|stringformat:"s"|add:"_answer_formset" %}
                            {% with answer_formset=answer_formsets|get_item:answer_formset_key %}
                                {% if answer_formset %}
                                    <div class="sub_container">
                                        {{ answer_formset.management_form }}
                                        {% for answer_form in answer_formset %}
                                            {{ answer_form.as_p }}
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="add_answer_form" name="{{ answer_formset_key }}">Add Answer</button>
                                {% endif %}
                            {% endwith %}
                        {% endwith %}
                    </div>
                {% endfor %}
                <button type="button" id="add_question_form">Add Question</button>
        </div>
    </form>
    <template id="question-empty-form">
        <div class="sub_container">
            {{ question_formset.empty_form.as_p }}
        </div>
    </template>
    <script>
        const addQuestionFormButton = document.getElementById('add_question_form');
        const questionFormContainer = document.getElementById('question_container');
        const emptyQuestionFormTemplate = document.getElementById('question-empty-form').content.cloneNode(true);
        const totalFormsInput = document.querySelector('#id_question_formset-TOTAL_FORMS');

        addQuestionFormButton.addEventListener("click", addForm);

        function addForm(event) {
            const newForm = emptyQuestionFormTemplate.cloneNode(true);
            
            // Update the form index
            const formCount = parseInt(totalFormsInput.value, 10);
            newForm.querySelectorAll('[name]').forEach(input => {
                input.name = input.name.replace('__prefix__', formCount);
                input.id = input.id.replace('__prefix__', formCount);
            });

            // Append the new form to the container
            questionFormContainer.insertBefore(newForm, addQuestionFormButton);

            // Increment the total form count
            totalFormsInput.value = formCount + 1;
        }
    </script>
{% endblock %}